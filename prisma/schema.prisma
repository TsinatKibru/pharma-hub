generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  PENDING
  ACTIVE
  REJECTED
}

enum UserRole {
  ADMIN
  OWNER
  STAFF
}

enum MovementType {
  INITIAL
  RESTOCK
  SALE
  ADJUSTMENT
  EXPIRY_REMOVAL
}

model Tenant {
  id            String       @id @default(cuid())
  name          String
  email         String       @unique
  slug          String       @unique
  address       String
  lat           Float?
  lng           Float?
  licenseNumber String?
  status        TenantStatus @default(PENDING)
  openingHours  Json?        // Structured: { monday: { open: "08:00", close: "20:00" }, ... }
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  users       User[]
  inventories Inventory[]
  sales       Sale[]

  @@index([slug])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole @default(STAFF)
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])
  movements StockMovement[]
}

model Medicine {
  id          String   @id @default(cuid())
  name        String
  genericName String?
  description String?
  category    String?
  imageURL    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventories Inventory[]

  @@index([name])
  @@index([category])
}

model Inventory {
  id                 String   @id @default(cuid())
  price              Decimal  @db.Decimal(10, 2)
  quantity           Int      @default(0)
  lowStockThreshold  Int      @default(10)
  batchNumber        String?
  expiryDate         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  medicineId String
  medicine   Medicine @relation(fields: [medicineId], references: [id])

  saleItems SaleItem[]
  movements StockMovement[]

  @@unique([tenantId, medicineId])
  @@index([expiryDate])
}

model StockMovement {
  id        String       @id @default(cuid())
  type      MovementType
  quantity  Int          // Delta: positive for restock, negative for sale/adjustment
  reason    String?
  createdAt DateTime     @default(now())

  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  userId      String
  user        User      @relation(fields: [userId], references: [id])

  @@index([inventoryId])
}

model Sale {
  id          String   @id @default(cuid())
  totalAmount Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  items SaleItem[]
}

model SaleItem {
  id        String  @id @default(cuid())
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)

  saleId      String
  sale        Sale      @relation(fields: [saleId], references: [id])
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
}
